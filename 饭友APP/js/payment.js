// ===== 支付页面逻辑 =====

class PaymentPage {
  constructor() {
    this.selectedRestaurant = null;
    this.paymentData = null;
    this.selectedPaymentMethod = 'wechat';
    
    this.init();
  }
  
  init() {
    this.loadPaymentData();
    this.bindEvents();
    this.setupPaymentMethods();
    this.calculatePayments();
  }
  
  loadPaymentData() {
    // 从本地存储加载餐厅信息\n    this.selectedRestaurant = Storage.get('selectedRestaurant');\n    \n    if (!this.selectedRestaurant) {\n      // 模拟餐厅数据\n      this.selectedRestaurant = {\n        id: '1',\n        name: '蜀香源川菜馆',\n        image: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=200'\n      };\n    }\n    \n    // 模拟订单数据\n    this.paymentData = {\n      restaurant: this.selectedRestaurant,\n      subtotal: 128.00,\n      deliveryFee: 8.00,\n      total: 136.00,\n      users: [\n        {\n          id: 'current_user',\n          name: '我',\n          avatar: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGRkQxMDAiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNyIgZmlsbD0iIzMzMzMzMyIvPgo8cGF0aCBkPSJNNiAzMkM4LjUgMjUgMTAgMjEgMjAgMjFTMzEuNSAyNSAzNCAzMiIgZmlsbD0iIzMzMzMzMyIvPgo8L3N2Zz4=',\n          amount: 34.00,\n          items: ['宫保鸡丁', '白米饭'],\n          paid: false\n        },\n        {\n          id: '1',\n          name: '小王',\n          avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100',\n          amount: 36.00,\n          items: ['麻婆豆腐', '白米饭'],\n          paid: true\n        },\n        {\n          id: '2',\n          name: '小李',\n          avatar: 'https://images.unsplash.com/photo-1494790108755-2616b2dc5b03?w=100',\n          amount: 32.00,\n          items: ['回锅肉'],\n          paid: false\n        },\n        {\n          id: '3',\n          name: '小张',\n          avatar: 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?w=100',\n          amount: 34.00,\n          items: ['酸菜鱼', '配送费分摊'],\n          paid: true\n        }\n      ],\n      estimatedTime: '13:15'\n    };\n    \n    this.updatePaymentUI();\n  }\n  \n  updatePaymentUI() {\n    // 更新餐厅信息\n    const restaurantName = document.getElementById('restaurantName');\n    if (restaurantName) {\n      restaurantName.textContent = this.paymentData.restaurant.name;\n    }\n    \n    const orderTime = document.getElementById('orderTime');\n    if (orderTime) {\n      orderTime.textContent = `预计送达：${this.paymentData.estimatedTime}`;\n    }\n    \n    const orderMembers = document.getElementById('orderMembers');\n    if (orderMembers) {\n      orderMembers.textContent = `${this.paymentData.users.length}人拼饭`;\n    }\n    \n    // 更新价格信息\n    const subtotal = document.getElementById('subtotal');\n    if (subtotal) {\n      subtotal.textContent = formatMoney(this.paymentData.subtotal);\n    }\n    \n    const deliveryFee = document.getElementById('deliveryFee');\n    if (deliveryFee) {\n      deliveryFee.textContent = formatMoney(this.paymentData.deliveryFee);\n    }\n    \n    const total = document.getElementById('total');\n    if (total) {\n      total.textContent = formatMoney(this.paymentData.total);\n    }\n    \n    // 更新个人支付金额\n    const currentUser = this.paymentData.users.find(u => u.id === 'current_user');\n    if (currentUser) {\n      const yourAmount = document.getElementById('yourAmount');\n      const btnAmount = document.getElementById('btnAmount');\n      \n      if (yourAmount) {\n        yourAmount.textContent = formatMoney(currentUser.amount);\n      }\n      if (btnAmount) {\n        btnAmount.textContent = formatMoney(currentUser.amount);\n      }\n    }\n  }\n  \n  bindEvents() {\n    // 关闭按钮\n    const closeBtn = document.getElementById('closeBtn');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        history.back();\n      });\n    }\n    \n    // 支付方式选择\n    document.querySelectorAll('.method-item').forEach(item => {\n      item.addEventListener('click', () => {\n        this.selectPaymentMethod(item.dataset.method);\n      });\n    });\n    \n    // 确认支付按钮\n    const confirmPayBtn = document.getElementById('confirmPayBtn');\n    if (confirmPayBtn) {\n      confirmPayBtn.addEventListener('click', this.handleConfirmPayment.bind(this));\n    }\n  }\n  \n  setupPaymentMethods() {\n    // 默认选择微信支付\n    this.selectPaymentMethod('wechat');\n  }\n  \n  selectPaymentMethod(method) {\n    this.selectedPaymentMethod = method;\n    \n    // 更新UI状态\n    document.querySelectorAll('.method-item').forEach(item => {\n      item.classList.remove('active');\n    });\n    \n    const selectedItem = document.querySelector(`[data-method=\"${method}\"]`);\n    if (selectedItem) {\n      selectedItem.classList.add('active');\n    }\n  }\n  \n  calculatePayments() {\n    // 渲染分账明细\n    const paymentList = document.getElementById('paymentList');\n    if (paymentList && this.paymentData) {\n      paymentList.innerHTML = '';\n      \n      this.paymentData.users.forEach(user => {\n        const paymentItem = createPaymentItem(user, user.amount, user.items);\n        paymentList.appendChild(paymentItem);\n      });\n    }\n    \n    // 渲染支付状态\n    const statusList = document.getElementById('statusList');\n    if (statusList && this.paymentData) {\n      statusList.innerHTML = '';\n      \n      this.paymentData.users.forEach(user => {\n        const statusItem = createPaymentStatusItem(user, user.paid);\n        statusList.appendChild(statusItem);\n      });\n    }\n  }\n  \n  async handleConfirmPayment() {\n    const confirmPayBtn = document.getElementById('confirmPayBtn');\n    if (!confirmPayBtn) return;\n    \n    try {\n      // 禁用按钮并显示加载状态\n      confirmPayBtn.disabled = true;\n      confirmPayBtn.innerHTML = `\n        <div class=\"loading-spinner\" style=\"width: 20px; height: 20px; margin-right: 8px;\"></div>\n        <span>支付中...</span>\n      `;\n      \n      // 获取当前用户信息\n      const currentUser = this.paymentData.users.find(u => u.id === 'current_user');\n      \n      const paymentData = {\n        groupId: 'current_group_id',\n        amount: currentUser.amount,\n        method: this.selectedPaymentMethod,\n        restaurant: this.paymentData.restaurant\n      };\n      \n      // 模拟支付请求\n      const result = await API.confirmPayment(paymentData);\n      \n      if (result.success) {\n        // 更新用户支付状态\n        currentUser.paid = true;\n        this.updatePaymentStatus();\n        \n        // 显示支付成功弹窗\n        this.showPaymentSuccess(result.orderId);\n      } else {\n        throw new Error('支付失败');\n      }\n      \n    } catch (error) {\n      console.error('支付失败:', error);\n      showToast('支付失败，请重试', 'error');\n      \n      // 恢复按钮状态\n      confirmPayBtn.disabled = false;\n      const currentUser = this.paymentData.users.find(u => u.id === 'current_user');\n      confirmPayBtn.innerHTML = `\n        <span class=\"btn-text\">确认支付</span>\n        <span class=\"btn-amount\">${formatMoney(currentUser.amount)}</span>\n      `;\n    }\n  }\n  \n  updatePaymentStatus() {\n    // 重新渲染支付状态\n    this.calculatePayments();\n    \n    // 检查是否所有人都已支付\n    const allPaid = this.paymentData.users.every(user => user.paid);\n    if (allPaid) {\n      setTimeout(() => {\n        showToast('所有成员支付完成，订单已确认！', 'success');\n      }, 1000);\n    }\n  }\n  \n  showPaymentSuccess(orderId) {\n    const successModal = document.getElementById('successModal');\n    if (successModal) {\n      // 更新订单号\n      const orderNumber = document.getElementById('orderNumber');\n      if (orderNumber) {\n        orderNumber.textContent = orderId;\n      }\n      \n      // 更新预计送达时间\n      const estimatedTime = document.getElementById('estimatedTime');\n      if (estimatedTime) {\n        estimatedTime.textContent = this.paymentData.estimatedTime;\n      }\n      \n      showModal('successModal');\n      \n      // 查看订单按钮\n      const viewOrderBtn = document.getElementById('viewOrderBtn');\n      if (viewOrderBtn) {\n        viewOrderBtn.addEventListener('click', () => {\n          // 保存订单信息\n          Storage.set('currentOrder', {\n            id: orderId,\n            restaurant: this.paymentData.restaurant,\n            amount: this.paymentData.users.find(u => u.id === 'current_user').amount,\n            estimatedTime: this.paymentData.estimatedTime,\n            status: 'confirmed'\n          });\n          \n          showToast('订单详情功能开发中...');\n          \n          // 3秒后返回首页\n          setTimeout(() => {\n            window.location.href = '../index.html';\n          }, 3000);\n        });\n      }\n      \n      // 播放支付成功音效（如果需要）\n      this.playSuccessSound();\n    }\n  }\n  \n  playSuccessSound() {\n    // 创建支付成功音效\n    const audioContext = new (window.AudioContext || window.webkitAudioContext)();\n    const oscillator = audioContext.createOscillator();\n    const gainNode = audioContext.createGain();\n    \n    oscillator.connect(gainNode);\n    gainNode.connect(audioContext.destination);\n    \n    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);\n    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);\n    \n    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);\n    \n    oscillator.start();\n    oscillator.stop(audioContext.currentTime + 0.3);\n  }\n}\n\n// 页面加载完成后初始化\ndocument.addEventListener('DOMContentLoaded', () => {\n  if (window.location.pathname.includes('payment.html')) {\n    window.paymentPage = new PaymentPage();\n  }\n});